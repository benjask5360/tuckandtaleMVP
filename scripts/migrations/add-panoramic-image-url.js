/**
 * Migration: Add panoramic_image_url column to content table
 *
 * This column stores the Supabase Storage URL for the full panoramic image
 * generated by Leonardo.ai before it's sliced into individual panels.
 *
 * Run with: node scripts/migrations/add-panoramic-image-url.js
 */

const { createClient } = require('@supabase/supabase-js');
require('dotenv').config({ path: '.env.local' });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

if (!supabaseUrl || !supabaseServiceKey) {
  console.error('âŒ Missing Supabase credentials in .env.local');
  process.exit(1);
}

const supabase = createClient(supabaseUrl, supabaseServiceKey);

async function addPanoramicImageUrlColumn() {
  console.log('ğŸ”„ Adding panoramic_image_url column to content table...\n');

  try {
    // Add the panoramic_image_url column
    const { error } = await supabase.rpc('exec_sql', {
      sql: `
        ALTER TABLE content
        ADD COLUMN IF NOT EXISTS panoramic_image_url TEXT;
      `
    });

    if (error) {
      // If exec_sql doesn't exist, try direct SQL via pg
      console.log('âš ï¸  exec_sql not available, trying alternative method...');

      // Alternative: Use Supabase SQL editor or direct database access
      console.log('\nğŸ“ Please run this SQL manually in Supabase SQL Editor:');
      console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
      console.log(`
ALTER TABLE content
ADD COLUMN IF NOT EXISTS panoramic_image_url TEXT;

COMMENT ON COLUMN content.panoramic_image_url IS 'URL to the full panoramic image from Leonardo.ai (before slicing)';
      `);
      console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');

      console.log('âœ… SQL statement prepared. Please run it manually in Supabase.');
      return;
    }

    console.log('âœ… Successfully added panoramic_image_url column to content table');

    // Verify the column was added
    const { data: columns, error: verifyError } = await supabase
      .from('content')
      .select('panoramic_image_url')
      .limit(1);

    if (verifyError) {
      console.log('âš ï¸  Could not verify column addition:', verifyError.message);
    } else {
      console.log('âœ… Column verified successfully');
    }

  } catch (err) {
    console.error('âŒ Error:', err.message);
    console.log('\nğŸ“ Please run this SQL manually in Supabase SQL Editor:');
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log(`
ALTER TABLE content
ADD COLUMN IF NOT EXISTS panoramic_image_url TEXT;

COMMENT ON COLUMN content.panoramic_image_url IS 'URL to the full panoramic image from Leonardo.ai (before slicing)';
    `);
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');
  }
}

addPanoramicImageUrlColumn();
